<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Sacos - Oscuro</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
/* ===== GENERAL ===== */
body{
  margin:0;
  font-family:system-ui, Arial;
  background:#121212;
  color:#f0f0f0;
  overflow-x:hidden;
}
header{
  background:#1f2937;
  color:#fff;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:6px;
  position:relative;
}

nav{
  display:flex;
  background:#1f2937;
  border-bottom:1px solid #333;
}
nav button{
  flex:1;
  padding:14px;
  border:none;
  background:none;
  font-weight:600;
  color:#ccc;
  font-size:1rem;
  cursor:pointer;
}
nav button.active{
  border-bottom:3px solid #2563eb;
  color:#fff;
}
#content{
  padding:12px;
  overflow-y:auto;
}
.card{
  background:#1e1e1e;
  border-radius:12px;
  padding:15px;
  margin-bottom:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.5);
}
input, button{
  width:100%;
  padding:12px;
  margin-bottom:8px;
  border-radius:8px;
  border:none;
  background:#2c2c2c;
  color:#fff;
  font-size:1rem;
}
button.primary{
  background:#2563eb;
  color:#fff;
  font-weight:600;
}

/* ===== CALENDARIO Y GR√ÅFICA ===== */
#calendar{
  width:100%;
  max-width:100%;
  margin:auto;
  background:#1e1e1e;
  border-radius:12px;
  padding:6px;
}
canvas{
  width:100% !important;
  max-width:100% !important;
  height:auto !important;
}

/* ===== EVENTOS ===== */
.green-event{ background:#4ade80!important; color:#000!important; }
.yellow-event{ background:#facc15!important; color:#000!important; }
.pickup-event{ background:#60a5fa!important; color:#000!important; }

/* ===== HEADER TEMPORADA ICONOS PEGADOS ===== */
.season-box {
  max-width: 250px;
}
.season-box select {
  width: 100%;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#2c2c2c;
  color:#fff;
  font-size:1rem;
  cursor:pointer;
}

/* ===== DATOS GENERALES Y NUEVA RECOGIDA ===== */
.card-dual {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}
.card-dual .card {
  flex: 1 1 48%;
  min-width: 220px;
}
@media(max-width:600px){
  .card-dual {
    flex-direction: column;
    gap: 12px;
  }
  .card-dual .card {
    flex: 1 1 100%;
  }
}
/* ===== MENU HAMBURGUESA ===== */
.menu-btn {
  width: auto;
}

.menu-dropdown {
  position: absolute;
  top: 50px;
  right: 0;
  background: #1e1e1e;
  border-radius: 10px;
  min-width: 160px;
  padding: 6px;
  box-shadow: 0 6px 20px rgba(0,0,0,.5);
  display: none;
  z-index: 9999;
}

.menu-dropdown.show {
  display: block;
}

.menu-dropdown div {
  padding: 12px;
  cursor: pointer;
  border-bottom: 1px solid #333;
}

.menu-dropdown div:last-child {
  border-bottom: none;
}

.menu-dropdown div:hover {
  background: #2c2c2c;
}

.menu-item{
  padding:10px;
  cursor:pointer;
  border-radius:6px;
}
.menu-item:hover{
  background:#2c2c2c;
}

.submenu{
  display:none;
  margin-left:10px;
  margin-top:6px;
  border-left:2px solid #2563eb;
  padding-left:8px;
}

.submenu.show{
  display:block;
}

.submenu div{
  padding:8px;
  border-radius:6px;
  cursor:pointer;
}
.submenu div:hover{
  background:#2c2c2c;
}

.submenu-action{
  font-weight:600;
}

.submenu-action.danger{
  color:#ef4444;
}

/* ===== DATOS GENERALES COMPACTOS ===== */
.card-datos {
  display: flex;
  align-items: center;
  gap: 8px;
  max-width: 350px;
  margin-bottom: 12px;
}

.card-datos input {
  flex: 1;
  margin-bottom: 0;
}

.card-datos button {
  width: 48px;
  height: 48px;
  padding: 0;
  font-size: 1.2rem;
}

/* ===== NUEVA RECOGIDA COMPACTA ===== */
.card-recogida {
  display: flex;
  align-items: center;
  gap: 8px;
  max-width: 350px;
  margin-bottom: 12px;
}

.card-recogida input {
  flex: 1;
  margin-bottom: 0;
}

.card-recogida button {
  width: 48px;
  height: 48px;
  padding: 0;
  font-size: 1.2rem;
}

/* D√≠as de lunes a viernes: blanco y texto negro */
.fc .weekday {
  background-color: #ffffff !important;
  color: #000000 !important;
}

/* Fines de semana: gris claro y texto negro */
.fc .weekend-day {
  background-color: #d1d5db !important;
  color: #000000 !important;
}

/* Encabezados de d√≠as de la semana (Lun, Mar, ...) en negro */
.fc .fc-col-header-cell-cushion {
  color: #000000 !important;
  font-weight: 600;
}

/* N√∫meros de semana */
.fc .fc-week-number {
  background-color: #f3f4f6 !important;
  color: #000000;
  font-weight: 600;
}

/* D√≠a actual */
.fc .fc-day-today {
  background-color: #fca5a5 !important;
  color: #000000 !important;
  font-weight: 600;
  border-radius: 4px;
}

/* ===== SACOS EN CASA ===== */
.card-casa {
  display: flex;
  align-items: center;
  gap: 8px;
  max-width: 350px; 
  margin-bottom: 12px;
}

.card-casa input {
  flex: 1;
  margin-bottom: 0;
  text-align: center;
}

.card-casa button {
  width: 40px;
  height: 40px;
  padding: 0;
  font-size: 1.2rem;
}
</style>
</head>
<body>

<header style="position:relative; display:flex; justify-content:space-between; align-items:center; padding:10px; background:#1f2937; color:#fff;">

  <!-- TEMPORADA A LA IZQUIERDA -->
  <div class="season-container">
    <div class="season-box">
      <select id="seasonSelect" style="cursor:pointer;"></select>
    </div>
  </div>

  <!-- BOT√ìN MEN√ö HAMBURGUESA A LA DERECHA -->
  <button class="menu-btn" id="menuBtn" style="font-size:1.5rem; background:#2c2c2c; border:none; border-radius:8px; padding:8px 12px; color:#fff; cursor:pointer;">
    ‚ò∞
  </button>

  <!-- DROPDOWN DEL MEN√ö -->
  <div class="menu-dropdown" id="menuDropdown" style="position:absolute; top:50px; right:0; background:#1e1e1e; border-radius:10px; min-width:220px; padding:8px; box-shadow:0 6px 20px rgba(0,0,0,.5); display:none; z-index:999;">
    <div onclick="openUser()" style="padding:6px; cursor:pointer;">üë§ Usuario</div>
    <div class="menu-item" onclick="toggleSeasonMenu(event)" style="padding:6px; cursor:pointer;">
      üì¶ Temporadas ‚ñæ
    </div>

    <div id="seasonSubmenu" class="submenu" style="display:none; padding-left:10px; margin-top:4px;">
      <div id="seasonMenuList"></div>
      <hr style="border-color:#333">
      <div class="submenu-action" style="padding:6px; cursor:pointer;" onclick="addSeason()">‚ûï A√±adir temporada</div>
      <div class="submenu-action danger" style="padding:6px; cursor:pointer; color:#ef4444;" onclick="deleteSeason()">‚ùå Eliminar temporada</div>
    </div>

    <div onclick="openAdmin()" style="padding:6px; cursor:pointer;">üõ† Panel del administrador</div>
    <div onclick="logout()" style="padding:6px; cursor:pointer;">üö™ Cerrar sesi√≥n</div>
  </div>

</header>

<nav>
  <button class="active" onclick="showDatos(this)">Datos</button>
  <button onclick="showCalendario(this)">Calendario</button>
  <button onclick="showGrafica(this)">Gr√°fica</button>
</nav>

<div id="content"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

// --- Firebase config ---
const firebaseConfig = { apiKey: "AIzaSyAM4pMCb1rPcZ_q-ncOMp4C8p9VTrt-qLc", authDomain: "sacos-pellet.firebaseapp.com", projectId: "sacos-pellet", storageBucket: "sacos-pellet.firebasestorage.app", messagingSenderId: "215063841201", appId: "1:215063841201:web:c36979a5ac466d3e061590" };

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const datosRef = doc(db,"datos","principal");
const content = document.getElementById("content");
const seasonSelect = document.getElementById("seasonSelect");

let data = {};
let currentSeason = "";

// ================= FUNCIONES AUXILIARES =================
function getCurrentSeasonData() {
  if (!currentSeason || !data[currentSeason]) {
    const seasons = Object.keys(data);
    if (seasons.length === 0) return null;
    currentSeason = seasons[0];
  }
  return data[currentSeason];
}

// ================= RENDER DATOS =================
function updateDatos() {
  const p = getCurrentSeasonData();
  if(!p) return;

  const resumenDiv = document.getElementById("resumenSacos");
  const pickupsDiv = document.getElementById("listPickups");
  if(!resumenDiv || !pickupsDiv) return;

  const hoy = new Date(); hoy.setHours(0,0,0,0);
  const consumidos = p.pickups.filter(r=>new Date(r.fecha)<=hoy).reduce((a,b)=>a+b.sacos,0);
  const restantes = Math.max(p.sacos - consumidos,0);
  const totalDisponible = restantes + (p.sacosCasa || 0);
  const dias = Math.round(totalDisponible * p.duracion);

  resumenDiv.innerHTML = `
    <p>üü¶ Sacos iniciales en almac√©n: <strong>${p.sacos}</strong></p>
    <p>üî¥ Consumidos: <strong>${consumidos}</strong></p>
    <p>üü¢ En almac√©n: <strong>${restantes}</strong></p>
    <p>üè† En casa: <strong>${p.sacosCasa || 0}</strong></p>
    <p>üì¶ Total disponible: <strong>${totalDisponible}</strong></p>
    <p>üìÖ Duraci√≥n estimada: <strong>${dias} d√≠as</strong></p>
  `;

  pickupsDiv.innerHTML = p.pickups.map((r,i)=>`${r.fecha} ‚Üí ${r.sacos} sacos <button onclick="deletePickup(${i})">‚ùå</button><br>`).join("") || "Sin recogidas";
}

function renderDatos() {
  const p = getCurrentSeasonData();
  if (!p) return;

  content.innerHTML = `
    <div class="card" id="resumenSacos"></div>
    <div class="card-dual">
      <div class="card">
      <h3>Datos generales</h3>
      <div class="card-datos">
    <input id="sacos" type="number" value="${p.sacos}">
    <input id="duracion" type="number" step="0.01" value="${p.duracion}">
    <button class="primary" onclick="saveGeneral()">üíæ</button>
  </div>
</div>

      <div class="card">
  <h3>Nueva recogida</h3>
  <div class="card-recogida">
    <input id="fecha" type="date">
    <input id="cantidad" type="number" placeholder="Sacos">
    <button class="primary" onclick="addPickup()">‚ûï</button>
  </div>
    </div>

    <div class="card">
  <h3>Sacos en casa</h3>
  <div class="card-casa">
    <button onclick="updateCasa(-1)">-</button>
    <input id="sacosCasa" type="number" value="${p.sacosCasa || 0}" readonly>
    <button onclick="updateCasa(1)">+</button>
  </div>
</div>

    <!-- BOT√ìN PARA VER RECOGIDAS -->
    <div class="card">
      <button id="togglePickups" class="primary">üëÅÔ∏è Ver recogidas</button>
      <div id="listPickups" style="display:none; max-height:300px; overflow-y:auto; margin-top:8px;"></div>
    </div>

    <div class="card">
      <button onclick="exportExcel()">üì§ Exportar a Excel</button>
    </div>
  `;

  updateDatos();

  // Evento para mostrar/ocultar recogidas
  const toggleBtn = document.getElementById("togglePickups");
  const pickupsDiv = document.getElementById("listPickups");

  toggleBtn.onclick = () => {
    if (pickupsDiv.style.display === "none") {
      pickupsDiv.style.display = "block";
      toggleBtn.textContent = "üîΩ Ocultar recogidas";
    } else {
      pickupsDiv.style.display = "none";
      toggleBtn.textContent = "üëÅÔ∏è Ver recogidas";
    }
  };
}

// ================= SACOS CASA =================
function updateCasa(delta){
  const p = getCurrentSeasonData();
  if(!p) return;

  if(p.sacosCasa === undefined) p.sacosCasa = 0;

  p.sacosCasa = Math.max(0, p.sacosCasa + delta);

  const casaInput = document.getElementById("sacosCasa");
  if(casaInput) casaInput.value = p.sacosCasa;

  saveGeneral();
}

// ¬°HACEMOS LA FUNCI√ìN GLOBAL PARA LOS BOTONES + Y -!
window.updateCasa = updateCasa;

// ================= FUNCIONES =================
async function saveGeneral(){
  const p = getCurrentSeasonData();
  if(!p) return;

  const sacosInput = document.getElementById("sacos");
  const duracionInput = document.getElementById("duracion");
  p.sacos = Number(sacosInput.value);
  p.duracion = Number(duracionInput.value);
  p.sacosCasa = p.sacosCasa || 0;

  await setDoc(datosRef, data);
  updateDatos();
}

async function addPickup() {
  const p = getCurrentSeasonData();
  if(!p) return;

  const fechaInput = document.getElementById("fecha");
  const cantidadInput = document.getElementById("cantidad");
  if(!fechaInput.value || !cantidadInput.value) return alert("Datos incompletos");

  p.pickups.push({ fecha: fechaInput.value, sacos: Number(cantidadInput.value) });
  await setDoc(datosRef, data);
  updateDatos();
}

async function deletePickup(i){
  const p = getCurrentSeasonData();
  if(!p) return;

  p.pickups.splice(i,1);
  await setDoc(datosRef, data);
  updateDatos();
}

async function addSeason(){
  const name = prompt("Nombre de la temporada");
  if(!name || data[name]) return;
  data[name] = { sacos:0, duracion:1, pickups:[] };
  currentSeason = name;
  await setDoc(datosRef, data);
  seasonSelect.innerHTML = Object.keys(data).map(s=>`<option>${s}</option>`).join("");
  seasonSelect.value = currentSeason;
  renderDatos();
}

async function deleteSeason(){
  if(!confirm("¬øBorrar temporada completa?")) return;
  delete data[currentSeason];
  currentSeason = Object.keys(data)[0] || "";
  await setDoc(datosRef, data);
  seasonSelect.innerHTML = Object.keys(data).map(s=>`<option>${s}</option>`).join("");
  seasonSelect.value = currentSeason;
  renderDatos();
}

// ================= CALENDARIO =================
function showCalendario(btn){
  const p = getCurrentSeasonData();
  if(!p) return;

  setActive(btn);
  content.innerHTML=`<div id="calendar"></div>`;
  const calEl = document.getElementById("calendar");

  const calendar = new FullCalendar.Calendar(calEl, {
    locale: "es",
    initialView: "dayGridMonth",
    firstDay: 1,
    height: "auto",
    dayCellClassNames: function(arg) {
      if(arg.date.getDay() === 0 || arg.date.getDay() === 6){
        return ['weekend-day'];
      } else {
        return ['weekday'];
      }
    }
  });

  if(p.pickups.length){
    p.pickups.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
    let primera = new Date(p.pickups[0].fecha);
    let ultima = new Date(p.pickups[p.pickups.length-1].fecha);

    let f = new Date(primera);
    while(f <= ultima){
      calendar.addEvent({
        start: f.toISOString().split("T")[0],
        allDay: true,
        classNames: ["yellow-event"]
      });
      f.setDate(f.getDate()+1);
    }

    p.pickups.forEach(r=>{
      calendar.addEvent({
        start: r.fecha,
        title: `-${r.sacos}`,
        allDay: true,
        classNames: ["pickup-event"]
      });
    });
  }

  // ===== AJUSTE: usar SACOS EN CASA para calcular d√≠as verdes =====
  let consumidos = p.pickups.reduce((a,b)=>a+b.sacos,0);
  let restantes = Math.max(p.sacos - consumidos,0);
  let totalDisponible = restantes + (p.sacosCasa || 0);
  let diasEstimados = Math.ceil(totalDisponible * p.duracion);

  // Fecha de inicio de d√≠as verdes
  let fechaInicioVerde = p.pickups.length ? new Date(p.pickups[p.pickups.length-1].fecha) : new Date();
  fechaInicioVerde.setDate(fechaInicioVerde.getDate()+1);

  for(let i=0;i<diasEstimados;i++){
    calendar.addEvent({
      start: fechaInicioVerde.toISOString().split("T")[0],
      allDay: true,
      classNames: ["green-event"]
    });
    fechaInicioVerde.setDate(fechaInicioVerde.getDate()+1);
  }

  calendar.render();
}

// ================= GR√ÅFICA =================
function showGrafica(btn){
  const p = getCurrentSeasonData();
  if(!p) return;

  setActive(btn);
  content.innerHTML=`<canvas id="chart"></canvas>`;
  let restantes = p.sacos;
  const labels=[], values=[];
  p.pickups.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha)).forEach(r=>{
    restantes -= r.sacos;
    labels.push(r.fecha);
    values.push(restantes);
  });
  new Chart(document.getElementById("chart"),{
    type:"line",
    data:{labels,datasets:[{label:"Sacos restantes",data:values,tension:.3,color:"#fff",borderColor:"#2563eb"}]},
    options:{
      plugins:{legend:{labels:{color:"#fff"}}},
      scales:{
        x:{ticks:{color:"#fff"},grid:{color:"#333"}},
        y:{ticks:{color:"#fff"},grid:{color:"#333"}}
      }
    }
  });
}

// ================= NAV =================
function setActive(btn){
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}
function showDatos(btn){ setActive(btn); renderDatos(); }

// ================= FIRESTORE SNAPSHOT =================
onSnapshot(datosRef,(docSnap)=>{
  if(!docSnap.exists()) return;
  data = docSnap.data();
  renderDatos();
});

// ================= INICIO =================
async function initApp(){
  const docSnap = await getDoc(datosRef);
  if(docSnap.exists()) data = docSnap.data();
  else { data = { "Invierno 2025-2026": { sacos:120,duracion:1.33,pickups:[] } }; await setDoc(datosRef,data); }
  currentSeason = Object.keys(data)[0] || "";
  seasonSelect.innerHTML = Object.keys(data).map(s=>`<option>${s}</option>`).join("");
  seasonSelect.value = currentSeason;
  renderDatos();
}

seasonSelect.onchange = ()=>{ currentSeason = seasonSelect.value; renderDatos(); };

initApp();

// ================= EXCEL =================
function exportExcel(){
  const p = getCurrentSeasonData();
  if(!p) return;

  const rows=[["Temporada","Fecha","Sacos"]];
  p.pickups.forEach(pick=>rows.push([currentSeason,pick.fecha,pick.sacos]));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,"Datos");
  XLSX.writeFile(wb,"sacos.xlsx");
}

// ================= USUARIO =================
async function logout(){ await signOut(auth); location.href = "index.html"; }
function openAdmin(){ alert("Aqu√≠ ir√° el panel de gesti√≥n de usuarios"); }
function openUser(){ const user = auth.currentUser; if(!user){ alert("No hay usuario autenticado"); return; } alert(`Usuario logueado: ${user.email}`); }

window.addPickup = addPickup;
window.deletePickup = deletePickup;
window.saveGeneral = saveGeneral;
window.addSeason = addSeason;
window.deleteSeason = deleteSeason;
window.showDatos = showDatos;
window.showCalendario = showCalendario;
window.showGrafica = showGrafica;
window.logout = logout;
window.openAdmin = openAdmin;
window.openUser = openUser;
</script>

<script>
const menuBtn = document.getElementById("menuBtn");
const menuDropdown = document.getElementById("menuDropdown");
const seasonSubmenu = document.getElementById("seasonSubmenu");
const seasonMenuList = document.getElementById("seasonMenuList");
const seasonSelect = document.getElementById("seasonSelect");

// === ABRIR / CERRAR MEN√ö PRINCIPAL ===
menuBtn.onclick = e => {
  e.stopPropagation();
  menuDropdown.style.display = menuDropdown.style.display === "block" ? "none" : "block";
};

// === ABRIR / CERRAR SUBMEN√ö TEMPORADAS ===
function toggleSeasonMenu(e){
  e.stopPropagation();
  seasonSubmenu.style.display = seasonSubmenu.style.display === "block" ? "none" : "block";
  renderSeasonMenu();
}

// === RENDERIZAR TEMPORADAS EN SUBMEN√ö ===
function renderSeasonMenu(){
  seasonMenuList.innerHTML = [...seasonSelect.options].map(o => `
    <div style="padding:6px; cursor:pointer;" onclick="selectSeasonFromMenu('${o.value}')">
      ${o.value}${o.value === seasonSelect.value ? " ‚úî" : ""}
    </div>
  `).join('');
}

// === SELECCIONAR TEMPORADA DESDE SUBMEN√ö ===
function selectSeasonFromMenu(season){
  seasonSelect.value = season;
  seasonSelect.dispatchEvent(new Event("change"));
  seasonSubmenu.style.display = "none";
  menuDropdown.style.display = "none";
}

// === CERRAR MEN√öS AL HACER CLICK FUERA ===
document.addEventListener("click", ()=>{
  menuDropdown.style.display = "none";
  seasonSubmenu.style.display = "none";
});
</script>

</body>
</html>

