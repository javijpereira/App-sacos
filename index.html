<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Sacos - Oscuro</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// Configuraci√≥n Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAM4pMCb1rPcZ_q-ncOMp4C8p9VTrt-qLc",
  authDomain: "sacos-pellet.firebaseapp.com",
  projectId: "sacos-pellet",
  storageBucket: "sacos-pellet.firebasestorage.app",
  messagingSenderId: "215063841201",
  appId: "1:215063841201:web:c36979a5ac466d3e061590"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const datosRef = doc(db, "datos", "principal");

// Cargar datos desde Firestore
async function loadData() {
  const docSnap = await getDoc(datosRef);
  if (docSnap.exists()) {
    data = docSnap.data();
    currentSeason = Object.keys(data)[0];
  } else {
    await setDoc(datosRef, data); // guardamos por primera vez
  }
  loadSeasons();
  showDatos(document.querySelector("nav button.active"));
}

// Guardar cambios en Firestore
async function save() {
  try {
    await setDoc(datosRef, data);
    console.log("Datos guardados en Firestore");
  } catch (err) {
    console.error("Error guardando en Firestore:", err);
  }
}


// Escuchar cambios en tiempo real
onSnapshot(datosRef, (docSnap) => {
  if (docSnap.exists()) {
    data = docSnap.data();
    console.log("Datos actualizados en tiempo real");
    loadSeasons();
    showDatos(document.querySelector("nav button.active"));
  }
});

// Llamamos a loadData al inicio
loadData();
</script>

<style>
/* ===== GENERAL ===== */
body{
  margin:0;
  font-family:system-ui, Arial;
  background:#121212;
  color:#f0f0f0;
  overflow-x:hidden;
}
header{
  background:#1f2937;
  color:#fff;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
header select, header button{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:none;
  background:#2c2c2c;
  color:#fff;
  font-size:1rem;
}
nav{
  display:flex;
  background:#1f2937;
  border-bottom:1px solid #333;
}
nav button{
  flex:1;
  padding:14px;
  border:none;
  background:none;
  font-weight:600;
  color:#ccc;
  font-size:1rem;
}
nav button.active{
  border-bottom:3px solid #2563eb;
  color:#fff;
}
#content{
  padding:12px;
  overflow-y:auto;
}
.card{
  background:#1e1e1e;
  border-radius:12px;
  padding:15px;
  margin-bottom:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.5);
}
input, button{
  width:100%;
  padding:12px;
  margin-bottom:8px;
  border-radius:8px;
  border:none;
  background:#2c2c2c;
  color:#fff;
  font-size:1rem;
}
button.primary{
  background:#2563eb;
  color:#fff;
  font-weight:600;
}
#calendar{
  width:100%;
  max-width:100%;
  margin:auto;
  background:#1e1e1e;
  border-radius:12px;
  padding:6px;
}
canvas{
  width:100% !important;
  max-width:100% !important;
  height:auto !important;
}

/* ===== EVENTOS ===== */
.green-event{ background:#4ade80!important; color:#000!important; }
.yellow-event{ background:#facc15!important; color:#000!important; }
.pickup-event{ background:#60a5fa!important; color:#000!important; }

/* ===== RESPONSIVE ===== */
@media(max-width:600px){
  header select, header button, nav button, input, button{
    font-size:1rem;
    padding:14px;
  }
}
</style>
</head>

<body>

<header>
  <select id="seasonSelect"></select>
  <button onclick="addSeason()">‚ûï A√±adir temporada</button>
  <button onclick="deleteSeason()">‚ùå Borrar temporada</button>
</header>

<nav>
  <button class="active" onclick="showDatos(this)">Datos</button>
  <button onclick="showCalendario(this)">Calendario</button>
  <button onclick="showGrafica(this)">Gr√°fica</button>
</nav>

<div id="content"></div>

<script>
/* ===== DATOS ===== */
let data; // vac√≠o al inicio
let currentSeason;

async function loadData() {
  const docSnap = await getDoc(datosRef);
  if (docSnap.exists()) {
    data = docSnap.data();
    console.log("Datos cargados desde Firestore");
  } else {
    // Si no existe, creamos datos iniciales
    data = { "Invierno 2025-2026": { sacos:120, duracion:1.33, pickups:[] } };
    await save(); // Guardamos los datos iniciales
    console.log("Documento creado en Firestore con datos iniciales");
  }
  currentSeason = Object.keys(data)[0];
  loadSeasons();
  showDatos(document.querySelector("nav button.active"));
}

// Llamada al inicio
loadData();



/* ===== TEMPORADAS ===== */
function loadSeasons(){
  seasonSelect.innerHTML = "";
  Object.keys(data).forEach(s => {
    seasonSelect.innerHTML += `<option>${s}</option>`;
  });
  seasonSelect.value = currentSeason;
}

seasonSelect.onchange = () => {
  currentSeason = seasonSelect.value;
  showDatos(document.querySelector("nav button.active"));
};

async function addSeason() {
  const name = prompt("Nombre de la temporada");
  if (!name || data[name]) return;
  data[name] = { sacos:0, duracion:1, pickups:[] };
  currentSeason = name;
  await save();
  loadSeasons();
  showDatos(document.querySelector("nav button.active"));
}

async function deleteSeason() {
  if (!confirm("¬øBorrar temporada completa?")) return;
  delete data[currentSeason];
  currentSeason = Object.keys(data)[0];
  await save();
  loadSeasons();
  showDatos(document.querySelector("nav button.active"));
}


/* ===== RESUMEN ===== */
 function resumenSacos(){
  const p=data[currentSeason];
  const hoy=new Date(); hoy.setHours(0,0,0,0);
  const consumidos=p.pickups
    .filter(r=>new Date(r.fecha)<=hoy)
    .reduce((a,b)=>a+b.sacos,0);
  const restantes=Math.max(p.sacos-consumidos,0);
  const dias=Math.round(restantes*p.duracion);
  return {consumidos,restantes,dias};
}

/* ===== NAV ===== */
 function setActive(btn){
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

/* ===== DATOS ===== */
 function showDatos(btn){
  setActive(btn);
  const p=data[currentSeason];
  const r=resumenSacos();

  content.innerHTML=`
    <div class="card">
      <h3>üì¶ Resumen de almac√©n</h3>
      <p>üü¶ Sacos iniciales: <strong>${p.sacos}</strong></p>
      <p>üî¥ Consumidos: <strong>${r.consumidos}</strong></p>
      <p>üü¢ En almac√©n: <strong>${r.restantes}</strong></p>
      <p>üìÖ Duraci√≥n estimada: <strong>${r.dias} d√≠as</strong></p>
    </div>

    <div class="card">
      <h3>Datos generales</h3>
      <input id="sacos" type="number" value="${p.sacos}">
      <input id="duracion" type="number" step="0.01" value="${p.duracion}">
      <button class="primary" onclick="saveGeneral()">Guardar</button>
    </div>

    <div class="card">
      <h3>Nueva recogida</h3>
      <input id="fecha" type="date">
      <input id="cantidad" type="number" placeholder="Sacos">
      <button class="primary" onclick="addPickup()">A√±adir</button>
    </div>

    <div class="card">
      <h3>Recogidas</h3>
      ${p.pickups.map((r,i)=>`${r.fecha} ‚Üí ${r.sacos} sacos <button onclick="deletePickup(${i})">‚ùå</button><br>`).join("") || "Sin recogidas"}
    </div>

    <div class="card">
      <button onclick="exportExcel()">üì§ Exportar a Excel</button>
    </div>
  `;
}

/* ===== DATOS GENERALES ===== */
async function saveGeneral() {
  data[currentSeason].sacos = +sacos.value;
  data[currentSeason].duracion = +duracion.value;
  await save();
  showDatos(document.querySelector("nav button.active"));
}

async function addPickup() {
  if (!fecha.value || !cantidad.value) return alert("Datos incompletos");
  data[currentSeason].pickups.push({ fecha: fecha.value, sacos: +cantidad.value });
  await save();
  showDatos(document.querySelector("nav button.active"));
}

async function deletePickup(i) {
  data[currentSeason].pickups.splice(i,1);
  await save();
  showDatos(document.querySelector("nav button.active"));
}

/* ===== CALENDARIO ===== */
 function showCalendario(btn){
  setActive(btn);
  content.innerHTML=`<div id="calendar"></div>`;
  const p=data[currentSeason];

  const calEl=document.getElementById("calendar");
  const calendar=new FullCalendar.Calendar(calEl,{
    locale:"es",
    initialView:"dayGridMonth",
    height:"auto"
  });

  if(p.pickups.length){
    // ordenar por fecha
    p.pickups.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));

    // pintar amarillo desde la primera hasta la √∫ltima recogida
    let primera=new Date(p.pickups[0].fecha);
    let ultima=new Date(p.pickups[p.pickups.length-1].fecha);
    let f=new Date(primera);
    while(f<=ultima){
      calendar.addEvent({start:f.toISOString().split("T")[0],allDay:true,classNames:["yellow-event"]});
      f.setDate(f.getDate()+1);
    }

    // eventos de recogida
    p.pickups.forEach(r=>{
      calendar.addEvent({
        start:r.fecha,
        title:`-${r.sacos}`,
        allDay:true,
        classNames:["pickup-event"]
      });
    });

    // calcular sacos restantes tras la √∫ltima recogida
    let consumidos=p.pickups.reduce((a,b)=>a+b.sacos,0);
    let sacosRestantes=Math.max(p.sacos - consumidos,0);

    // empezar estimaci√≥n verde desde el d√≠a siguiente a la √∫ltima recogida
    let fechaEstimada = new Date(ultima);
    fechaEstimada.setDate(fechaEstimada.getDate()+1);

    let diasEstimados = Math.ceil(sacosRestantes * p.duracion); // duraci√≥n en d√≠as
    for(let i=0;i<diasEstimados;i++){
      calendar.addEvent({
        start: fechaEstimada.toISOString().split("T")[0],
        allDay: true,
        classNames:["green-event"]
      });
      fechaEstimada.setDate(fechaEstimada.getDate()+1);
    }
  }

  calendar.render();
}

/* ===== GR√ÅFICA ===== */
function showGrafica(btn){
  setActive(btn);
  content.innerHTML=`<canvas id="chart"></canvas>`;
  const p=data[currentSeason];
  let restantes=p.sacos;
  const labels=[], values=[];

  p.pickups
    .sort((a,b)=>new Date(a.fecha)-new Date(b.fecha))
    .forEach(r=>{
      restantes-=r.sacos;
      labels.push(r.fecha);
      values.push(restantes);
    });

  new Chart(document.getElementById("chart"),{
    type:"line",
    data:{labels,datasets:[{label:"Sacos restantes",data:values,tension:.3,color:"#fff",borderColor:"#2563eb"}]},
    options:{
      plugins:{legend:{labels:{color:"#fff"}}},
      scales:{
        x:{ticks:{color:"#fff"},grid:{color:"#333"}},
        y:{ticks:{color:"#fff"},grid:{color:"#333"}}
      }
    }
  });
}

/* ===== EXCEL ===== */
function exportExcel(){
  const rows=[["Temporada","Fecha","Sacos"]];
  data[currentSeason].pickups.forEach(p=>{
    rows.push([currentSeason,p.fecha,p.sacos]);
  });
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,"Datos");
  XLSX.writeFile(wb,"sacos.xlsx");
}

</script>

</body>
</html>

